name: Batch Release
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New version (e.g. v0.4.0)'
        required: true

jobs:
  batch-release:
    runs-on: ubuntu-latest
    env:
      ORG: "farseer-go"  # æ›¿æ¢ä¸ºä½ çš„ GitHub ç»„ç»‡æˆ–ç”¨æˆ·å
      REPO_LIST: "fs collections"  # ç›´æ¥åœ¨æ­¤åˆ—å‡ºæ‰€æœ‰ç»„ä»¶ä»“åº“å tasks utils mapper webapi eventBus queue linkTrace cache cacheMemory data docker elasticSearch etcd rabbit redis fSchedule monitor
    steps:
      - name: Validate Input
        run: |
          if [[ ! "${{ github.event.inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬å·å¿…é¡»æ˜¯ vX.Y.Z æ ¼å¼ï¼ˆå¦‚ v0.4.0ï¼‰"
            exit 1
          fi

      - name: Batch Update and Release
        run: |
          set -euxo pipefail  # å¯ç”¨è¯¦ç»†æ—¥å¿—å’Œä¸¥æ ¼é”™è¯¯æ£€æŸ¥
          NEW_VERSION="${{ github.event.inputs.version }}"

          # è½¬æ¢ä¸ºæ•°ç»„å¹¶å¤„ç†ç©ºæ ¼åˆ†éš”çš„ä»“åº“åˆ—è¡¨
          read -ra REPOS <<< "$REPO_LIST"

          # å®‰è£… GitHub CLI
          type -p gh >/dev/null || sudo apt-get install -y gh

          # ç™»å½• GitHub CLI
          echo "${{ secrets.RELEASE_PAT }}" | gh auth login --with-token

          for REPO in "${REPOS[@]}"; do
            echo "ğŸ”§ æ­£åœ¨å¤„ç†ä»“åº“: $REPO"

            # å…‹éš†ä»“åº“
            TEMP_DIR=$(mktemp -d)
            git clone "https://$PAT@github.com/$ORG/$REPO.git" "$TEMP_DIR"
            cd "$TEMP_DIR"

            # æ¸…ç†ä¾èµ–
            go get -u && go mod tidy

            # æ›´æ–°æ‰€æœ‰ä¾èµ–åˆ°æ–°ç‰ˆæœ¬
            for DEP in "${REPOS[@]}"; do
              if [[ "$DEP" != "$REPO" ]]; then
                go mod edit -replace "github.com/$ORG/$DEP=github.com/$ORG/$DEP@$NEW_VERSION"
              fi
            done

            # æäº¤æ›´æ”¹
            git config user.name "Release Bot"
            git config user.email "bot@example.com"
            git add go.mod
            if ! git commit -m "chore: update dependencies to $NEW_VERSION"; then
              echo "ğŸŸ¡ æ— å˜æ›´éœ€è¦æäº¤: $REPO"
              continue
            fi

            # å¼ºåˆ¶æ¨é€æ ‡ç­¾ï¼ˆè¦†ç›–æ—§æ ‡ç­¾ï¼‰
            git tag -f "$NEW_VERSION"
            git push origin main
            git push origin "$NEW_VERSION" --force

            # åˆ›å»º GitHub Release
            gh release create "$NEW_VERSION" \
              --title "$NEW_VERSION" \
              --notes "Release version $NEW_VERSION" \
              --repo "$ORG/$REPO"

            # æ¸…ç†ä¸´æ—¶ç›®å½•
            cd ..
            rm -rf "$TEMP_DIR"
          done

          echo "âœ… æ‰€æœ‰ä»“åº“å·²æ›´æ–°è‡³ $NEW_VERSION"
        env:
          PAT: ${{ secrets.RELEASE_PAT }}  # éœ€è¦å…·æœ‰ä»“åº“å†™å…¥æƒé™çš„ PAT