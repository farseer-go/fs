name: Batch Release
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New version (e.g. v0.4.0)'
        required: true

jobs:
  batch-release:
    runs-on: ubuntu-latest
    env:
      ORG: "farseer-go"  # æ›¿æ¢ä¸ºä½ çš„ GitHub ç»„ç»‡æˆ–ç”¨æˆ·å
      REPO_LIST: "fs collections tasks utils mapper webapi eventBus queue linkTrace cache cacheMemory data docker elasticSearch etcd rabbit redis fSchedule monitor"  # ç›´æ¥åœ¨æ­¤åˆ—å‡ºæ‰€æœ‰ç»„ä»¶ä»“åº“å
    steps:
      - name: Validate Input
        run: |
          if [[ ! "${{ github.event.inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬å·å¿…é¡»æ˜¯ vX.Y.Z æ ¼å¼ï¼ˆå¦‚ v0.4.0ï¼‰"
            exit 1
          fi
      - name: Install GitHub CLI
        run: |
            sudo apt-get update
            sudo apt-get install -y gh

      - name: Batch Update and Release
        run: |
          set -euxo pipefail  # å¯ç”¨è¯¦ç»†æ—¥å¿—å’Œä¸¥æ ¼é”™è¯¯æ£€æŸ¥
          NEW_VERSION="${{ github.event.inputs.version }}"

          # è½¬æ¢ä¸ºæ•°ç»„å¹¶å¤„ç†ç©ºæ ¼åˆ†éš”çš„ä»“åº“åˆ—è¡¨
          read -ra REPOS <<< "$REPO_LIST"

          for REPO in "${REPOS[@]}"; do
            echo "ğŸŸ¡ ğŸŸ¡ ğŸŸ¡ ğŸŸ¡ ğŸŸ¡ ğŸŸ¡ æ­£åœ¨å¤„ç†ä»“åº“: $REPOğŸŸ¡ ğŸŸ¡ ğŸŸ¡ ğŸŸ¡ ğŸŸ¡ ğŸŸ¡ "

            # å…‹éš†ä»“åº“
            TEMP_DIR=$(mktemp -d)
            git clone "https://${{ secrets.RELEASE_PAT }}@github.com/$ORG/$REPO.git" "$TEMP_DIR"
            cd "$TEMP_DIR"

            go get -u && go mod tidy

            # éå†æ‰€æœ‰éœ€è¦æ›´æ–°çš„ä¾èµ–ç»„ä»¶
            for DEP in "${REPOS[@]}"; do
                # ç²¾å‡†æ›¿æ¢ä¾èµ–ç‰ˆæœ¬ï¼ˆé¿å…è¯¯æ”¹å…¶ä»–æ¨¡å—ï¼‰
                sed -i "s|github.com/$ORG/$DEP v[0-9]\+.[0-9]\+.[0-9]\+|github.com/$ORG/$DEP $NEW_VERSION|g" go.mod
            done

            # æäº¤ã€ä¸»æ¨¡å—ã€‘æ›´æ”¹
            git config user.name "Release Bot"
            git config user.email "bot@example.com"
            git add .
            if ! git commit -m "chore: update dependencies to $NEW_VERSION"; then
              echo "ğŸŸ¡ æ— å˜æ›´éœ€è¦æäº¤: $REPO"
            fi
            
            # åˆ›å»ºã€ä¸»æ¨¡å—ã€‘æ–°æ ‡ç­¾
            git tag -f "$NEW_VERSION"
            git push origin main --force
            git push origin "$NEW_VERSION" --force
            
            # æ ¹æ®ä»“åº“ç±»å‹å®šä¹‰å­æ¨¡å—è·¯å¾„
            case "$REPO" in
                data)
                SUB_MODULES=("driver/clickhouse" "driver/sqlite" "driver/postgres" "driver/sqlserver")
                ;;
                webapi)
                SUB_MODULES=("session-redis")
                ;;
                *)
                SUB_MODULES=()
                ;;
            esac

            # é€’å½’å¤„ç†æ‰€æœ‰æŒ‡å®šæ¨¡å—
            for SUB_PATH in "${SUB_MODULES[@]}"; do
                if [[ -f "$SUB_PATH/go.mod" ]]; then
                echo "ğŸ”§ å¤„ç†æ¨¡å—: $SUB_PATH"
                pushd "$SUB_PATH" > /dev/null

                go get -u && go mod tidy

                # éå†æ‰€æœ‰éœ€è¦æ›´æ–°çš„ä¾èµ–ç»„ä»¶
                for DEP in "${REPOS[@]}"; do
                    # ç²¾å‡†æ›¿æ¢ä¾èµ–ç‰ˆæœ¬ï¼ˆé¿å…è¯¯æ”¹å…¶ä»–æ¨¡å—ï¼‰
                    sed -i "s|github.com/$ORG/$DEP v[0-9]\+.[0-9]\+.[0-9]\+|github.com/$ORG/$DEP $NEW_VERSION|g" go.mod
                done
                
                # æäº¤ã€å­æ¨¡å—ã€‘æ›´æ”¹
                git add .
                if ! git commit -m "chore: update dependencies to $NEW_VERSION"; then
                    echo "ğŸŸ¡ æ— å˜æ›´éœ€è¦æäº¤: $REPO"
                fi

                # åˆ›å»ºã€å­æ¨¡å—ã€‘æ–°æ ‡ç­¾
                git tag -f "$SUB_PATH/$NEW_VERSION"
                git push origin "$SUB_PATH/$NEW_VERSION" --force

                popd > /dev/null
                else
                    echo "â© è·³è¿‡æ— æ•ˆè·¯å¾„: $SUB_PATH"
                fi
            done

            # æ£€æŸ¥ Release æ˜¯å¦å·²å­˜åœ¨
            if gh release view "$NEW_VERSION" --repo "$ORG/$REPO" >/dev/null 2>&1; then
                echo "ğŸŸ¡ Release $NEW_VERSION å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
            else
                # åˆ›å»º GitHub Releaseï¼ˆæ— éœ€æ˜¾å¼ç™»å½•ï¼‰
                gh release create "$NEW_VERSION" --title "$NEW_VERSION" --notes "Release version $NEW_VERSION" --repo "$ORG/$REPO"
            fi

            # æ¸…ç†ä¸´æ—¶ç›®å½•
            cd ..
            rm -rf "$TEMP_DIR"
          done

          echo "âœ… æ‰€æœ‰ä»“åº“å·²æ›´æ–°è‡³ $NEW_VERSION"
        env:
            GH_TOKEN: ${{ secrets.RELEASE_PAT }}  # å¿…é¡»è®¾ç½®
            GITHUB_TOKEN: ${{ secrets.RELEASE_PAT }}  # åŒé‡ä¿éšœ